
# Глава 39–40: Работа с ошибками в HTTP API и рекомендации по проектированию
*([переработка статей из книги «API», разделы «HTTP API & REST»](https://habr.com/ru/articles/745446/))*

---

## Глава 39. Работа с ошибками в HTTP API

### Почему это важно

В реальном мире "happy path" — идеальное выполнение запроса — встречается не всегда. Куда чаще — ошибки. Как клиенту, так и серверу важно понимать:

- Кто допустил ошибку
- Можно ли повторить запрос?
- Что нужно изменить в запросе?
- Насколько фатальна ошибка?

---

## Примеры возможных ошибок при `POST /v1/orders`

1. Ошибки синтаксиса JSON
2. Отсутствие токена авторизации
3. Невалидный токен
4. Нет прав у пользователя
5. Пользователь удалён
6. Неверный user_id
7. Не передана ревизия
8. Конфликт ревизии
9. Не заполнены обязательные поля
10. Некорректные значения
11. Превышение лимита запросов
12. Перегрузка сервера
13. Неизвестная ошибка

---

## Коды ошибок и когда их использовать

| Код | Смысл                              | Поведение клиента                  |
|-----|------------------------------------|------------------------------------|
| 400 | Ошибка запроса (валидация, синтаксис) | Исправить запрос                   |
| 401 | Отсутствует/неверный токен         | Запросить логин                    |
| 403 | Доступ запрещён                    | Обратиться к админу                |
| 404 | Ресурс не найден                   | Возможен повтор позже              |
| 409 | Конфликт (ревизия, дубликат)       | Разрешить конфликт вручную         |
| 410 | Удалённый ресурс                   | Не повторять                       |
| 429 | Слишком много запросов             | Повторить позже                    |
| 500 | Внутренняя ошибка сервера          | Повторить позже                    |
| 503 | Временно недоступен                | Повторить позже + Retry-After      |

---

## Пример машиночитаемой ошибки

```http
HTTP/1.1 400 Bad Request
X-OurCoffeeAPI-Error-Kind: wrong_parameter_value

{
  "reason": "wrong_parameter_value",
  "localized_message": "Что-то пошло не так. Обратитесь к разработчику.",
  "details": {
    "checks_failed": [{
      "field": "recipe",
      "error_type": "wrong_value",
      "message": "Value 'lngo' unknown. Did you mean 'lungo'?"
    }, {
      "field": "position.latitude",
      "error_type": "constraint_violation",
      "constraints": {
        "min": -90,
        "max": 90
      },
      "message": "'position.latitude' must fall within [-90, 90]"
    }]
  }
}
```

---

## Серверные ошибки и Retry-After

```http
HTTP/1.1 500 Internal Server Error
Retry-After: 5

{
  "reason": "internal_server_error",
  "localized_message": "Не удалось получить ответ. Попробуйте позже.",
  "details": {
    "can_be_retried": true,
    "is_operation_failed": "unknown"
  }
}
```

---

## Подходы к организации ошибок

1. Расширять список кодов (не всегда понятно)
2. Возвращать только 400/500 и всё объяснять в теле (прозрачно, но не REST)
3. Гибрид: коды + детализация (рекомендуется)

---

## Глава 40. Общие рекомендации по проектированию HTTP API

1. Проработать "happy path"
2. Описать все ресурсы и методы
3. Определить возможные ошибки и сценарии восстановления
4. Решить, какие фичи реализуются на уровне HTTP
5. Написать спецификацию
6. Протестировать в виде псевдокода

---

## Советы по стилю

- Всегда добавляйте `/` в конец URL
- Указывайте `Date`, `Content-Type`, `Cache-Control` и др.
- Поддерживайте `OPTIONS` и CORS
- Используйте `camelCase` и соблюдайте casing везде
- Возвращайте JSON-объекты, даже если пустые: `{}` или `204 No Content`
- Определяйте кэширование в `GET`-запросах
- Не используйте `GET` для изменений, `PUT/DELETE` — только идемпотентно

---

# Безопасность HTTP API

## CSRF — Cross-Site Request Forgery

**Решение:**
- Используйте CSRF-токены
- Проверяйте заголовок `Origin` и `Referer`
- Запрещайте `Cookie`-авторизацию из внешних доменов

## SSRF — Server-Side Request Forgery

**Решение:**
- Никогда не делайте запросы по URL, полученным от клиента, без валидации
- Запрещайте доступ к IP `127.0.0.1`, `169.254.0.0/16`, `localhost`, etc.
- Используйте allowlist доменов

## HTTP Response Splitting

**Решение:**
- Экранируйте все заголовки
- Запрещайте символы `
`, `
` в пользовательских данных

## Unvalidated Redirects and Forwards

**Решение:**
- Разрешайте редиректы только на заранее известные URL
- Используйте redirect token или slug вместо полного URL

---

## Заключение

HTTP API — это мощный инструмент стандартизованного общения между клиентом и сервером. Соблюдение принципов REST, правильная работа с ошибками и внимание к безопасности делают API удобным, предсказуемым и безопасным.

